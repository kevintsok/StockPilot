# StockPilot

Python toolkit for A-share data collection, LLM-based scoring, and a Transformer that predicts next-day close. Includes a web control panel and a built-in long/short backtester.

99% coding is generated by Codex guided by kevintsok

## Features
- Data: fetch full/partial daily prices and financials into SQLite and cached npz/preprocessed tensors.
- Modeling: causal Transformer encoder; checkpoints store scaler and config for reproducible inference.
- Inference: reusable `PricePredictor` API and CLI for one-off predictions.
- Backtest: long-only or long/short on predicted next-day returns (top/bottom N%), supports costs/slippage, turnover, and concentration stats.
- Ops dashboard: local web UI to fetch data, train, infer, render dashboards, and launch backtests with live logs.
- Reports: HTML leaderboard and realtime dashboard.

## Quickstart
Examples use your Python at `/home/julian/miniconda3/envs/fin/bin/python3`; ensure `PYTHONPATH=./src` from repo root.

Install
```bash
/home/julian/miniconda3/envs/fin/bin/python3 -m pip install -r requirements.txt
```

Fetch history
```bash
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli fetch-all --start 2018-01-01
```

Train Transformer
```bash
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli \
  train-transformer --seq-len 60 --epochs 20 --batch-size 64 --device cuda \
  --save-path models/price_transformer.pt
```

Predict next-day close
```bash
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli \
  predict-transformer 600000 --seq-len 60 --checkpoint models/price_transformer.pt
```

Backtest (add `--allow-short` for long/short)
```bash
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli \
  backtest-transformer 000001 000002 --start 2023-01-01 --end 2023-06-30 \
  --top-pct 0.1 --checkpoint models/price_transformer.pt --cost-bps 0 --slippage-bps 0
```

### Backtest CLI reference
- `backtest-transformer`：按指定股票集合（默认沪深/创业板）收集预测收益，基于全窗口做一次多空权重分配（`--top-pct`，`--allow-short`），输出总体回测指标；`--eval-batch-size` 控制跨股票窗口的推理 batch。
- `backtest-strategy`：逐日批量推理、排序、取前 `--top-k` 做多（不做空），权重按预测收益比例分配，成本/滑点支持同上，结果写到 checkpoint 同目录 JSON。
- `backtest-per-symbol`：针对每只股票单独跑一遍 `backtest`，保存每只股票的窗口收益/指标到 CSV；`--workers>1` 多进程并行（每进程各自加载模型），`--workers=1` 复用单模型顺序跑；该入口内部仍是单股票推理，不做跨股票合批。

Ops dashboard (control panel)
```bash
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.ops_dashboard
# open http://127.0.0.1:8000
```

LLM scoring + HTML report
```bash
export OPENAI_API_KEY=your_key
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli score --top 50 --provider openai
PYTHONPATH=./src /home/julian/miniconda3/envs/fin/bin/python3 -m auto_select_stock.cli render --top 50 --output reports/undervalued.html
```

## Layout
- `src/auto_select_stock/`
  - `config.py` – paths/config
  - `storage.py` – SQLite I/O (read-only support)
  - `data_fetcher.py`, `financials_fetcher.py` – data ingestion
  - `predict/` – `data.py`, `torch_model.py`, `inference.py`, `strategy.py`, `backtest.py`, `train.py`
  - `cli.py` – fetch/train/predict/backtest/render commands
  - `ops_dashboard.py` – local web control panel
  - `html_report.py`, `dashboard.py` – HTML outputs
  - `llm/`, `scoring.py` – LLM scoring

## Notes
- Override defaults with `AUTO_SELECT_STOCK_DATA_DIR`, `AUTO_SELECT_MODEL_DIR`, `AUTO_SELECT_STOCK_PREPROCESSED_DIR`.
- Ignore caches/pyc in git (clean tracked pyc via `git ls-files '*.pyc' | xargs -r git rm --cached`).
- CUDA warnings are benign on CPU-only machines; inference falls back to CPU.
